document.addEventListener('DOMContentLoaded', () => {
    const themeToggleBtn = document.querySelector('.theme-toggle');
    const body = document.body;
    const savedTheme = localStorage.getItem('theme');

    if (savedTheme === 'light') {
        body.classList.add('light-mode');
        if(themeToggleBtn) themeToggleBtn.innerText = 'üåô';
    } else {
        if(themeToggleBtn) themeToggleBtn.innerText = '‚òÄÔ∏è';
    }

    if(themeToggleBtn){
        themeToggleBtn.addEventListener('click', () => {
            body.classList.toggle('light-mode');
            if (body.classList.contains('light-mode')) {
                localStorage.setItem('theme', 'light');
                themeToggleBtn.innerText = 'üåô';
            } else {
                localStorage.setItem('theme', 'dark');
                themeToggleBtn.innerText = '‚òÄÔ∏è';
            }
        });
    }

    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const cartCountEl = document.querySelector('#cart-count');
    const modal = document.getElementById('cart-modal');
    const cartBtn = document.querySelector('.cart-btn');
    const closeBtn = document.querySelector('.close-modal');
    const cartItemsList = document.getElementById('cart-items-list');
    const finalTotalEl = document.getElementById('final-total');

    function updateCartCount() {
        if(cartCountEl) cartCountEl.innerText = cart.length;
    }
    updateCartCount();

    function formatPrice(price) {
        return new Intl.NumberFormat('fa-IR').format(price);
    }

    function renderCart() {
        if(!cartItemsList) return;
        cartItemsList.innerHTML = '';
        let totalPrice = 0;

        if (cart.length === 0) {
            cartItemsList.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-muted);">ÿ≥ÿ®ÿØ ÿÆÿ±€åÿØ ÿÆÿßŸÑ€å ÿßÿ≥ÿ™.</p>';
        } else {
            cart.forEach((item, index) => {
                totalPrice += parseInt(item.price);
                const itemEl = document.createElement('div');
                itemEl.classList.add('cart-item');
                itemEl.innerHTML = `
                    <div class="item-info">
                        <h4 style="font-size:1rem; color:var(--text-main)">${item.title}</h4>
                        <span style="font-size:0.85rem; color:var(--accent-color)">${formatPrice(item.price)} ÿ™ŸàŸÖÿßŸÜ</span>
                    </div>
                    <button class="remove-item" data-index="${index}">ÿ≠ÿ∞ŸÅ</button>
                `;
                cartItemsList.appendChild(itemEl);
            });
        }
        if(finalTotalEl) finalTotalEl.innerText = formatPrice(totalPrice);

        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const indexToRemove = e.target.getAttribute('data-index');
                cart.splice(indexToRemove, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartCount();
                renderCart();
            });
        });
    }

    const addToCartBtns = document.querySelectorAll('.add-to-cart');
    addToCartBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const product = { id: btn.dataset.id, title: btn.dataset.title, price: btn.dataset.price };
            cart.push(product);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            if(modal) { modal.style.display = 'block'; renderCart(); }
        });
    });

    if(cartBtn) cartBtn.addEventListener('click', () => { modal.style.display = 'block'; renderCart(); });
    if(closeBtn) closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
    window.addEventListener('click', (event) => { if (event.target === modal) modal.style.display = 'none'; });
});